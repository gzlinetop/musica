<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>MiPlayer — Corregido</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">


<style>
  :root{
    --bg:#f2f5f8;
    --left:#6C4AE2;
    --left-dark:#5a39d1;
    --white:#ffffff;
    --muted:#9aa4b2;
    --accent:#ffb86b;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#fff,#f3f6fb);color:#111;-webkit-font-smoothing:antialiased;overflow-x:hidden}
  .wrap{
    width:100%;
    max-width:1100px;
    margin:16px auto;
    padding:12px;
    display:flex;
    gap:16px;
    align-items:flex-start;
    box-sizing:border-box;
    min-width:0;
  }
  /* LEFT */
.left {
    flex: 0 0 420px;
    min-width: 0;
    background: linear-gradient(180deg, rgb(0 0 0 / 70%), #065fd4), url(https://img.freepik.com/fotos-premium/leon-cara-negra-hojas-primer-plano_731790-66485.jpg) center / cover no-repeat;
    border-radius: 24px;
    padding: 18px;
    box-shadow: 0 18px 40px rgba(15, 10, 40, 0.18);
    color: #fff;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 520px;
    transition: transform .22s 
ease, opacity .22s 
ease, display .1s;
}


  .left.hidden{display:none}
  .top-controls{width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  
.icon-btn {
    width: 60px;
    height: 30px;
    border-radius: 12px;
    background: rgb(11 72 153);
    display: flex;
    align-items: center;
    justify-content: center;
    border: 0;
    color: #fff;
    cursor: pointer;
}
  
  .title-small{font-size:12px;opacity:0.95;letter-spacing:2px}
  .player-area{margin-top:12px;width:100%;display:flex;flex-direction:column;align-items:center;gap:10px}
.vinyl {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    box-shadow: 0 14px 36px rgb(10 2 22);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: transform .3s 
ease;
}

  .ring{width:86%;height:86%;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));display:flex;align-items:center;justify-content:center;position:relative}
  .track-title{font-weight:700;font-size:20px;margin-top:12px;text-align:center}
  .track-sub{color:rgba(255,255,255,0.88);font-size:13px;margin-top:6px;text-align:center}

  /* video box (cuadro visible) */
  .video-box{
    width:100%;
    max-width:320px;
    height:180px;
    background:#000;
    border-radius:12px;
    overflow:hidden;
    margin-top:12px;
    display:block;
    box-shadow:0 10px 26px rgba(2,6,23,0.24);
    position:relative;
    z-index:2;
  }
  .video-box iframe, .video-box > div { width:100%; height:100%; border:0; display:block; }

  .controls{display:flex;align-items:center;gap:14px;margin-top:18px}
  .control{width:52px;height:52px;border-radius:12px;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;border:0;color:#fff}
  
.play {
    width: 76px;
    height: 76px;
    border-radius: 16px;
    background: radial-gradient(circle at 30% 30%, #c4adb7, #847e87);
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
    transition: transform 0.25s ease, box-shadow 0.25s ease;
    animation: pulse 2s infinite ease-in-out; /* efecto latido */
}

/* efecto hover */
.play:hover {
    transform: scale(1.08);
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35), 0 0 12px rgba(255, 255, 255, 0.4);
}

/* animación de pulsación */
@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
    }
    50% {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35), 0 0 10px rgba(200, 200, 255, 0.4);
    }
}

  
.progress {
    width: 84%;
    height: 8px;
    background: rgb(157 144 154);
    border-radius: 999px;
    margin-top: 14px;
    overflow: hidden;
}


  .progress .bar{height:100%;width:0;background:linear-gradient(90deg,#065fd4,#3f3f3f);transition:width .35s linear}


  /* RIGHT */
.right {
    flex: 1;
    min-width: 0;
    min-height: 520px;
    background: linear-gradient(145deg, #ffffff, #f3f6fb);
    border-radius: 24px;
    padding: 24px;
    box-shadow: 0 12px 30px rgba(18, 20, 40, 0.08), inset 0 2px 6px rgba(255, 255, 255, 0.9), inset 0 -2px 8px rgba(0, 0, 0, 0.06);
    display: flex;
    flex-direction: column;
    position: relative;
    transition: all 0.3s 
ease;
}
  
  /* overlays placed behind content so input remains visible */
  .right.search-active::before,
  .right.search-active::after { content:""; position:absolute; width:80px; top:0;bottom:0;pointer-events:none;backdrop-filter: blur(8px); opacity:.55; border-radius:24px; z-index:0; }
  .right.search-active::before{ left:0; background:linear-gradient(90deg, rgba(255,255,255,0.95), rgba(255,255,255,0)); pointer-events:none; }
  .right.search-active::after{ right:0; background:linear-gradient(270deg, rgba(255,255,255,0.95), rgba(255,255,255,0)); pointer-events:none; }

  .search-row{display:flex;gap:8px;align-items:center}
  .search-box{flex:1;background:#f6f9ff;border-radius:12px;padding:8px 10px;display:flex;align-items:center;gap:8px;border:1px solid rgba(16,24,40,0.04);position:relative;z-index:3}
  .search-box input{flex:1;border:0;background:transparent;outline:0;font-size:15px;color:#0b1220;caret-color:#0b1220}
  .actions-row{display:flex;gap:8px;align-items:center;margin-top:12px;justify-content:space-between}
  .section-tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:8px 12px;border-radius:12px;background:transparent;color:var(--muted);font-weight:600;cursor:pointer;border:1px solid rgba(16,24,40,0.03)}
  .tab.active{background:linear-gradient(90deg,#f2f6ff,#ffffff);color:#111;box-shadow:0 8px 24px rgba(16,20,40,0.04)}

  .list{margin-top:12px;overflow:auto;padding-bottom:30px;min-height:120px}
  .song{display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;cursor:pointer}
  .song:hover{background:linear-gradient(90deg,rgba(10,10,20,0.02),rgba(10,10,20,0.01))}
  .thumb{width:62px;height:62px;border-radius:10px;background-size:cover;background-position:center;flex-shrink:0}
  .song .meta{flex:1;min-width:0}
  .song .meta .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .song .meta .sub{color:var(--muted);font-size:13px;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .song .btns{display:flex;gap:8px}
  .song .btns .icon-btn{width:36px;height:36px;padding:6px;background:#f2f4f8;color:#111;border:1px solid rgba(16,24,40,0.04)}

  /* favorite button style (small heart) */
  .btn-fav.local { font-weight:700; font-size:14px; display:flex; align-items:center; justify-content:center; }

  /* right panel icon buttons adjustment so they are visible on light bg */
  .right .icon-btn{background:#f2f4f8;color:#111;border:1px solid rgba(16,24,40,0.04);width:40px;height:40px;padding:6px}

  /* mini player */
  .mini{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#ffffff;border-radius:14px;padding:6px 10px;box-shadow:0 12px 40px rgba(15,10,40,0.12);display:flex;align-items:center;gap:10px;min-width:260px;max-width:640px;z-index:999}
  .mini.hidden{display:none}
  .mthumb{width:72px;height:72px;border-radius:10px;background-size:cover;background-position:center;flex-shrink:0} /* aumentado para que se vea mejor */
  .mmeta{flex:1;min-width:0}
  .mname{font-weight:700; font-size:13px; /* pequeño y legible */ }
  .msub{color:var(--muted);font-size:12px}

  /* modal & toast */
  .modal-bg{position:fixed;inset:0;background:rgba(12,10,20,0.45);display:flex;align-items:center;justify-content:center;z-index:10000}
  .modal{background:var(--white);padding:14px;border-radius:12px;min-width:280px;max-width:420px;max-height:80vh;overflow:auto}
  .modal .pl-row{display:flex;gap:8px;padding:8px;align-items:center;cursor:pointer}
  .modal .pl-row .pl-thumb{width:44px;height:44px;background-size:cover;border-radius:8px;flex-shrink:0}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:120px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;z-index:10001}

  /* responsive */
  @media(max-width:980px){
    .wrap{flex-direction:column;padding:12px}

    .left{width:100%;flex-basis:auto;min-height:420px}
    .right{width:100%;min-height:360px}
    .mini{left:12px;transform:none;right:12px;max-width:calc(100% - 24px)}
    .video-box{max-width:100%;height:180px}
    /* ensure create playlist button visible on small screens (moved to left panel) */
    #btnCreatePL{width:44px;height:40px;padding:6px;border-radius:10px;font-weight:700;display:flex;align-items:center;justify-content:center}
    /* mini adjustments for small screens */
    .mthumb{width:56px;height:56px}
    .mname{font-size:12px}
    .modal{max-width:100%;min-width:100%;border-radius:12px 12px 0 0;height:60vh;overflow:auto}
    .modal-bg{align-items:flex-end}
    .modal .pl-row{padding:10px}
    .thumb{width:54px;height:54px}
  }

  @media(max-width:480px){
    .mini{min-width:200px;padding:6px 8px}
    .mthumb{width:48px;height:48px}
    .mname{font-size:12px}
    .msub{font-size:11px}
    .modal{height:65vh}
    .thumb{width:48px;height:48px}
  }



/* ---- mini-player: estado "detrás" mientras se busca ---- */
.right { position: relative; z-index: 20; } /* asegurar que el panel derecho esté por encima cuando sea necesario */

.mini {
  transition: transform .18s ease, opacity .18s ease, z-index .18s;
  z-index: 999; /* valor original */
}

/* cuando tiene la clase .behind, lo llevamos detrás del panel derecho */
.mini.behind {
  z-index: 5;              /* menor que .right (20) para que quede detrás */
  opacity: 0.95;           /* ligero cambio visual */
  transform: translateY(8px) scale(0.985); /* pequeño ajuste visual para indicar 'apagado' */
  pointer-events: none;    /* evita interacciones mientras está detrás */
}


/* -------------------------
   Autocomplete / Suggestions
   ------------------------- */
.search-box { position: relative; z-index: 30; } /* asegurar posicion relativa para el dropdown */
#suggestions{
  position: absolute;
  top: calc(100% + 8px);
  left: 0;
  right: 0;
  background: #ffffff;
  border-radius: 10px;
  box-shadow: 0 12px 30px rgba(18,20,40,0.06);
  max-height: 320px;
  overflow: auto;
  display: none;
  padding: 6px 6px;
  border: 1px solid rgba(16,24,40,0.04);
}
.suggestion-item{
  padding: 8px;
  border-radius: 8px;
  cursor: pointer;
  display:flex;
  gap:8px;
  align-items:center;
  transition: background .12s ease;
  user-select: none;
}
.suggestion-item + .suggestion-item{ margin-top:6px; }
.suggestion-item:hover, .suggestion-item.active{ background: linear-gradient(90deg,#f2f6ff,#ffffff); }
.suggestion-thumb{ width:46px; height:46px; border-radius:8px; background-size:cover; background-position:center; flex-shrink:0; }
.suggestion-body{ min-width:0; overflow:hidden; }
.suggestion-title{ font-weight:700; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.suggestion-sub{ color:var(--muted); font-size:12px; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }



/* ----- Toggle button styles (shuffle / repeat) ----- */
/* base: fuerza colores y transiciones profesionales */
.control.toggle {
  transition: transform .18s ease, box-shadow .18s ease, background .18s ease, color .18s ease;
  position: relative;
  overflow: visible;
}

/* estilo activo general (verde elegante) */
.control.toggle.active,
.control.toggle.repeat-all,
.control.toggle.repeat-one {
  background: linear-gradient(180deg,#14b37a,#0ea36a); /* verde */
  box-shadow: 0 8px 22px rgba(16,120,85,0.18), 0 2px 6px rgba(0,0,0,0.12) inset;
  color: #fff;
  transform: translateY(-2px);
}

/* iconos dentro del botón blanco para mejor contraste */
.control.toggle.active svg path,
.control.toggle.repeat-all svg path,
.control.toggle.repeat-one svg path {
  fill: #fff !important;
  stroke: #fff !important;
}

/* estado inactivo sutil */
.control.toggle.inactive {
  opacity: 0.65;
  filter: none;
}

/* indicador "one": pequeño badge con 1 sobre el botón */
.control.toggle.repeat-one::after{
  content: "1";
  position: absolute;
  top: 6px;
  right: 6px;
  background: #fff;
  color: #0a7a4f;
  font-weight:700;
  font-size:11px;
  width:18px;
  height:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:50%;
  box-shadow: 0 2px 6px rgba(0,0,0,0.18);
}

/* indicador "all": pequeño brillo adicional (opcional) */
.control.toggle.repeat-all::before{
  content: "";
  position: absolute;
  inset: -6px;
  border-radius: 14px;
  background: radial-gradient(closest-side, rgba(20,179,122,0.08), transparent);
  z-index: -1;
}

/* shuffle active style (un tag específico si quieres otro color) */
.control.toggle.shuffle-active{
  background: linear-gradient(180deg,#08a3ff,#007fd6); /* azul si quieres diferenciar */
  box-shadow: 0 10px 24px rgba(2,80,160,0.12);
}


</style>
</head>
<body>
<div class="wrap">
  <!-- LEFT -->
  <div class="left" id="leftCard" aria-label="Reproductor">
    <div class="top-controls">
      <div class="title-small">SysAccessVip Music</div>
      <div style="display:flex;gap:8px">
        <button class="icon-btn" id="btnQueue" title="Cola">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 7h18M3 12h18M3 17h12" stroke="currentColor" stroke-width="1.6"></path></svg>
        </button>
        <button class="icon-btn" id="btnMinimize" title="Minimizar">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M6 12h12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path></svg>
        </button>
      </div>
    </div>

    <div class="player-area">
      <div class="vinyl" id="vinylCover" style="background-image:url('https://iili.io/KMLE6Ol.png')">
        <div class="ring" id="ringInner">
          <div id="vinylCenter" style="width:48px;height:48px;border-radius:50%;background:rgba(0,0,0,0.12);display:flex;align-items:center;justify-content:center">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none"></svg>
          </div>
        </div>
      </div>

      <div style="text-align:center">
        <div class="track-title" id="nowTitle">Disfruta tu música</div>
        <div class="track-sub" id="nowArtist">Busca y reproduce</div>
      </div>

      <!-- video rectangular visible -->
      <div class="video-box" id="videoBox">
        <div id="ytVisible"></div>
      </div>

      <div class="controls">
        <button class="control" id="shuffleBtn" title="Aleatorio">

          <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
  <path fill="currentColor" d="M3 4h4.5l4.5 6 4.5-6H21v2h-3l-3.8 5.1L18 16h3v2h-5.5L12 12.5 7.5 18H3v-2h3l3.8-5.1L6 6H3V4z"></path>
</svg>

        </button>
        <button class="control" id="prevBtn" title="Anterior">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M19 18V6L11 12l8 6zM5 6v12" stroke="currentColor" stroke-width="1.6"></path></svg>
        </button>

        <button class="play" id="playBtn" title="Play/Pausa">
          <svg id="playIcon" width="30" height="30" viewBox="0 0 24 24" fill="none"><path d="M5 3v18l15-9L5 3z" fill="#1b0a00"></path></svg>
        </button>

        <button class="control" id="nextBtn" title="Siguiente">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M5 6v12l8-6-8-6zM19 6v12" stroke="currentColor" stroke-width="1.6"></path></svg>
        </button>
        <button class="control" id="repeatBtn" title="Repetir">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <path d="M21 12a8.5 8.5 0 0 0-8.5-8.5H7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
  <path d="M21 6v6h-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
  <path d="M3 12a8.5 8.5 0 0 0 8.5 8.5h6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
  <path d="M3 18v-6h6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>

        </button>
      </div>

      <div class="progress" aria-hidden="false">
        <div class="bar" id="progressBar"></div>
      </div>

      <div style="display:flex;gap:8px;margin-top:14px;align-items:center">
        <button class="icon-btn" id="btnVideoToggle" title="Ocultar/Ver video">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><rect x="3" y="6" width="14" height="12" rx="2" stroke="currentColor" stroke-width="1.4"></rect><path d="M21 8v8" stroke="currentColor" stroke-width="1.4"></path></svg>
        </button>

        <!-- Muevo aqui el boton de crear playlist para que sea visible en movil -->
        <button class="icon-btn" id="btnCreatePL" title="Crear playlist" style="width:44px;height:40px;padding:6px;font-weight:700">+</button>

        <button class="icon-btn" id="btnFullScreen" title="Pantalla completa">
<svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
  <path fill="currentColor" d="M3 3h6v2H5v4H3V3zm12 0h6v6h-2V5h-4V3zm6 12v6h-6v-2h4v-4h2zm-12 6H3v-6h2v4h4v2z"></path>
</svg>

        </button>
      </div>
    </div>


  </div>

  <!-- RIGHT -->
  <div class="right" id="rightPanel">


    <div class="search-row">

<div class="search-box">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6"></path></svg>
  <input id="searchInput" placeholder="Buscar (máx 7 resultados)" autocomplete="off" aria-autocomplete="list" aria-controls="suggestions" aria-haspopup="listbox"/>
  <button id="searchBtn" class="icon-btn" style="width:40px;height:40px;padding:6px" aria-label="Buscar">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6"></path></svg>
  </button>

  <!-- contenedor para las sugerencias -->
  <div id="suggestions" role="listbox" aria-label="Sugerencias de búsqueda"></div>
</div>



      <div style="display:flex;gap:8px">
        <!-- Boton de favoritos eliminado según tu pedido -->
      </div>
    </div>

    <div class="actions-row">
      <div class="section-tabs" role="tablist">
        <div class="tab active" data-tab="tab-list">Lista</div>
        <div class="tab" data-tab="tab-recientes">Recientes</div>
        <div class="tab" data-tab="tab-favorites">Favoritos</div>
        <div class="tab" data-tab="tab-playlists">Playlists</div>
      </div>
      <div class="muted">Tus canciones</div>
    </div>

    <div class="list" id="listArea">
      <div style="padding:32px;text-align:center;color:var(--muted)">Busca una canción para comenzar</div>
    </div>
  </div>
</div>

<!-- mini player -->
<div class="mini hidden" id="miniPlayer" aria-hidden="true">
  <div class="mthumb" id="miniThumb" style="background-image:url('https://dummyimage.com/600x600/222/fff')"></div>
  <div class="mmeta">
    <div class="mname" id="miniTitle">No se reproduce</div>
    <div class="msub" id="miniArtist">—</div>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <button class="icon-btn" id="miniPrev"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M19 18V6L11 12l8 6zM5 6v12" stroke="currentColor" stroke-width="1.2"></path></svg></button>
    <button class="icon-btn" id="miniPlay"><svg id="miniPlayIcon" width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M5 3v18l15-9L5 3z" fill="#111"></path></svg></button>
    <button class="icon-btn" id="miniNext"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M5 6v12l8-6-8-6zM19 6v12" stroke="currentColor" stroke-width="1.2"></path></svg></button>
  </div>
</div>

<!-- modal & toast -->
<div id="modalRoot" class="hidden"></div>
<div id="toastRoot" class="hidden"></div>

<!-- YT holder (hidden iframe will be appended here) -->
<div id="ytApiHolder" style="display:none"></div>

<script>
/* =====================
   Config + Storage
   ===================== */
/* --- REEMPLAZAR AQUI: bloque CONFIG completo --- */
const CONFIG = {
  YT_MAX_RESULTS: 7,
  API_KEYS: [
    // keys antiguas (conservadas)
    "AIzaSyCzu-Mqx22V83ktalXksUnC1AhtZwzyb-0",
    "AIzaSyBM-uvKMHe5GxNuMpWB45-RWVUGYOGwEyQ",
    "AIzaSyAd6JdvYn7YGMfSY9EaJtCEUGd11tKa6ZI",
    "AIzaSyBr2nxeKaN1q07fMV59zrLEOQx9dzYBsMI",
    "AIzaSyBbnepAY-irFm35H7Qu0NrwISzLCThkBKM",
    "AIzaSyAujlR4Gig8puLuzM-amckcwu5sbMRvIR0",
    "AIzaSyBiGJ9JeOdkrUI7x-qQHyrHpUJAxcwRTvI",
    "AIzaSyC_UCUc3zcffX5_IOPFpqbJyXmUYxKOg9U",
    // keys nuevas que nos diste (añadidas al final)
    "AIzaSyC7FYbsVmGA0LnepHG7t_xPOR0mEkQ1jiE",
    "AIzaSyBLTPa7EUAmnJZMq4sYBT97x4HY3--YHws",
    "AIzaSyDWAi-0_oqg5GHwEoE0_LnSLSV_nsfs1SI",
    "AIzaSyBJ6zZI3BFvBd02EcdsJFE7dLdZ-f7RV9c",
    "AIzaSyD_9Flh18VT4hJ0OkEIS3TCECJ4vIOcfC0",
    "AIzaSyC3_rIZ5deseDbte7auVOo7oUDjopEMaBg",
    "AIzaSyA9jC-p2NtbeppL8x0YKQqNkrdOggt3Q48"
  ],
  STORAGE_PREFIX: 'mp_'
};
/* --- FIN REEMPLAZO --- */


let STORAGE = {
  recent: JSON.parse(localStorage.getItem(CONFIG.STORAGE_PREFIX + 'recent') || '[]'),
  favorites: JSON.parse(localStorage.getItem(CONFIG.STORAGE_PREFIX + 'fav') || '[]'),
  playlists: JSON.parse(localStorage.getItem(CONFIG.STORAGE_PREFIX + 'playlists') || '{}'),
  keyIndex: parseInt(localStorage.getItem(CONFIG.STORAGE_PREFIX + 'key_index') || '0', 10) || 0
};
function saveStorage(){ localStorage.setItem(CONFIG.STORAGE_PREFIX + 'recent', JSON.stringify(STORAGE.recent)); localStorage.setItem(CONFIG.STORAGE_PREFIX + 'fav', JSON.stringify(STORAGE.favorites)); localStorage.setItem(CONFIG.STORAGE_PREFIX + 'playlists', JSON.stringify(STORAGE.playlists)); localStorage.setItem(CONFIG.STORAGE_PREFIX + 'key_index', STORAGE.keyIndex.toString()); }
function getCurrentKeyAndAdvance(advance=false){ const keys = CONFIG.API_KEYS; let idx = STORAGE.keyIndex % keys.length; const key = keys[idx]; if(advance){ STORAGE.keyIndex = (idx + 1) % keys.length; saveStorage(); } return {key, idx}; }

/* =====================
   UI helpers
   ===================== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const modalRoot = $('#modalRoot');
const toastRoot = $('#toastRoot');

/* showModal mejorado: en pantallas pequeñas aparece como bottom-sheet */
function showModal({title='', html='', buttons=[]}){
  modalRoot.innerHTML = `<div class="modal-bg"><div class="modal"><div style="font-weight:700;margin-bottom:8px">${title}</div><div id="modalBody">${html}</div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px" id="modalBtns"></div></div></div>`;
  modalRoot.classList.remove('hidden');
  const btnArea = document.getElementById('modalBtns');
  buttons.forEach(btn=>{
    const b = document.createElement('button');
    b.className = 'icon-btn';
    b.textContent = btn.label;
    b.style.padding = '8px 12px';
    b.addEventListener('click', ()=>{
      if(btn.onClick) btn.onClick();
      if(btn.close !== false) closeModal();
    });
    btnArea.appendChild(b);
  });

  // Si la pantalla es angosta, transformar modal en bottom-sheet para mejor UX en móvil
  const modalBg = modalRoot.querySelector('.modal-bg');
  const modalEl = modalRoot.querySelector('.modal');
  if(window.innerWidth <= 480){
    modalEl.style.maxWidth = '100%';
    modalEl.style.minWidth = '100%';
    modalEl.style.height = '60vh';
    modalEl.style.borderRadius = '12px 12px 0 0';
    modalEl.style.margin = '0';
    modalBg.style.alignItems = 'flex-end';
  } else {
    modalEl.style.maxWidth = '';
    modalEl.style.minWidth = '';
    modalEl.style.height = '';
    modalEl.style.borderRadius = '';
    modalBg.style.alignItems = 'center';
  }

  // allow clicking overlay to close
  modalBg.addEventListener('click', (ev)=>{
    if(ev.target === modalBg) closeModal();
  });
}
function closeModal(){ modalRoot.classList.add('hidden'); modalRoot.innerHTML = ''; }

function showToast(msg, ms=1800){
  toastRoot.innerHTML = `<div class="toast">${msg}</div>`;
  toastRoot.classList.remove('hidden');
  setTimeout(()=>{ toastRoot.classList.add('hidden'); toastRoot.innerHTML=''; }, ms);
}

/* =====================
   YouTube search with rotation
   ===================== */
async function youtubeSearch(query, maxResults=CONFIG.YT_MAX_RESULTS){
  if(!query || !query.trim()) return [];
  const q = encodeURIComponent(query);
  for(let i=0;i<CONFIG.API_KEYS.length;i++){
    const {key, idx} = getCurrentKeyAndAdvance(i>0);
    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=${maxResults}&q=${q}&key=${key}`;
    try{
      const res = await fetch(url);
      if(!res.ok) { continue; }
      const data = await res.json();
      STORAGE.keyIndex = idx; saveStorage();
      return (data.items || []).map(it=>({
        videoId: it.id.videoId,
        title: it.snippet.title,
        channel: it.snippet.channelTitle,
        thumb: it.snippet.thumbnails?.high?.url || it.snippet.thumbnails?.default?.url
      }));
    }catch(err){ continue; }
  }
  showToast('No fue posible conectar con YouTube');
  return [];
}

/* =====================
   Player & state
   ===================== */
let visiblePlayer = null;
let hiddenPlayer = null;
let playersReady = false;
let pendingPlay = null; // {videoId, autoplay}
let queue = [];
let currentIndex = -1;
let currentTrack = null;
let isPlaying = false;
let repeatMode = 'none';
let shuffle = false;
let progressTimer = null;
let videoShown = true;

(function loadYT(){ const t = document.createElement('script'); t.src = "https://www.youtube.com/iframe_api"; document.body.appendChild(t); })();

window.onYouTubeIframeAPIReady = function(){
  visiblePlayer = new YT.Player('ytVisible', {
    width:'100%', height:'100%',
    playerVars:{autoplay:0,controls:1,rel:0,modestbranding:1,playsinline:1},
    events:{onReady:onVisibleReady, onStateChange:onStateChange, onError:onPlayerError}
  });
  const holder = document.createElement('div'); holder.id = 'ytHiddenHolder'; holder.style.display='none'; document.getElementById('ytApiHolder').appendChild(holder);
  hiddenPlayer = new YT.Player(holder.id, {
    width:0, height:0,
    playerVars:{autoplay:0,controls:0,rel:0,modestbranding:1,playsinline:1},
    events:{onReady:onHiddenReady, onStateChange:onStateChange, onError:onPlayerError}
  });
};

function onVisibleReady(){ checkPlayersReady(); }
function onHiddenReady(){ checkPlayersReady(); }
function checkPlayersReady(){
  if(visiblePlayer && hiddenPlayer){ playersReady = true;
    if(pendingPlay){ try{ loadAndPlayById(pendingPlay.videoId, pendingPlay.autoplay); }catch(e){} pendingPlay = null; }
  }
}

function onStateChange(e){
  const s = e.data;
  if(s === YT.PlayerState.PLAYING){ isPlaying = true; setPlayIcon(true); startProgressTimer(); showMini(true); spinVinyl(true); }
  else if(s === YT.PlayerState.PAUSED){ isPlaying = false; setPlayIcon(false); stopProgressTimer(); spinVinyl(false); }
  else if(s === YT.PlayerState.ENDED){ if(repeatMode === 'one'){ playCurrent(); } else { playNext(); } }
}
function onPlayerError(e){ console.warn('YT error', e); showToast('Error reproductor'); }

/* robust loading: if players not ready, set pendingPlay */
function loadAndPlayById(videoId, autoplay=true, setQueue=true, indexOverride=null){
  if(!videoId) return;
  if(setQueue && indexOverride!==null) currentIndex = indexOverride;
  currentTrack = queue[currentIndex] || {videoId, title:'', channel:'', thumb:''};
  updateNowCard(currentTrack);
  if(!playersReady){
    pendingPlay = {videoId, autoplay};
    showToast('Cargando reproductor...');
    return;
  }
  try{
    const useVisible = videoShown && visiblePlayer && typeof visiblePlayer.loadVideoById === 'function';
    if(useVisible){
      visiblePlayer.loadVideoById({videoId, startSeconds:0});
      if(autoplay) visiblePlayer.playVideo();
    } else {
      hiddenPlayer.loadVideoById({videoId, startSeconds:0});
      if(autoplay) hiddenPlayer.playVideo();
    }
  }catch(e){
    console.warn('loadAndPlay error', e);
    showToast('Error iniciar reproducción');
  }
  addRecent(currentTrack);
  saveStorage();
}

function playCurrent(){ if(currentIndex<0 || currentIndex>=queue.length) return; loadAndPlayById(queue[currentIndex].videoId, true, true, currentIndex); }
function playNext(){
  if(queue.length===0) return;
  if(shuffle) currentIndex = Math.floor(Math.random()*queue.length); else currentIndex++;
  if(currentIndex >= queue.length){
    if(repeatMode === 'all') currentIndex = 0;
    else { currentIndex = queue.length -1; stopPlayback(); return; }
  }
  playCurrent();
}
function playPrev(){
  try{
    const p = (videoShown && visiblePlayer && visiblePlayer.getCurrentTime) ? visiblePlayer : hiddenPlayer;
    if(p && p.getCurrentTime && p.seekTo){
      const cur = p.getCurrentTime();
      if(cur > 3){ p.seekTo(0, true); return; }
    }
  }catch(e){}
  currentIndex--;
  if(currentIndex < 0){
    if(repeatMode === 'all') currentIndex = queue.length - 1;
    else currentIndex = 0;
  }
  playCurrent();
}
function stopPlayback(){
  try{ visiblePlayer && visiblePlayer.stopVideo && visiblePlayer.stopVideo(); }catch(e){}
  try{ hiddenPlayer && hiddenPlayer.stopVideo && hiddenPlayer.stopVideo(); }catch(e){}
  isPlaying = false; setPlayIcon(false); stopProgressTimer(); spinVinyl(false);
}
function togglePlayPause(){ const p = (videoShown && visiblePlayer && visiblePlayer.getPlayerState) ? visiblePlayer : hiddenPlayer; if(!p || typeof p.getPlayerState !== 'function') return; const s = p.getPlayerState(); if(s === YT.PlayerState.PLAYING) p.pauseVideo(); else p.playVideo(); }
function setPlayIcon(playing){
  $('#playIcon').innerHTML = playing ? `<path d="M6 19h4V5H6v14zM14 5v14h4V5h-4z" fill="#1b0a00"></path>` : `<path d="M5 3v18l15-9L5 3z" fill="#1b0a00"></path>`;
  const miniSvg = $('#miniPlayIcon');
  if(miniSvg) miniSvg.innerHTML = playing ? `<path d="M6 19h4V5H6v14zM14 5v14h4V5h-4z" fill="#111"></path>` : `<path d="M5 3v18l15-9L5 3z" fill="#111"></path>`;
}
function startProgressTimer(){ stopProgressTimer(); progressTimer = setInterval(()=>{ try{ const p = (videoShown && visiblePlayer && visiblePlayer.getCurrentTime) ? visiblePlayer : hiddenPlayer; if(!p || !p.getDuration) return; const dur = p.getDuration() || 0; const cur = p.getCurrentTime() || 0; const pct = dur > 0 ? (cur/dur)*100 : 0; $('#progressBar').style.width = pct + '%'; }catch(e){} }, 400); }
function stopProgressTimer(){ if(progressTimer) clearInterval(progressTimer); progressTimer=null; }

/* vinyl spin */
let vinylInterval = null;
function spinVinyl(on){
  const el = $('#vinylCover');
  if(!el) return;
  if(on){
    let angle = 0;
    if(vinylInterval) clearInterval(vinylInterval);
    vinylInterval = setInterval(()=>{ angle = (angle+0.9)%360; el.style.transform = `rotate(${angle}deg)`; }, 30);
  } else { if(vinylInterval) clearInterval(vinylInterval); vinylInterval=null; el.style.transform='rotate(0deg)'; }
}

/* update UI */
function updateNowCard(track){
  if(!track) return;
  $('#nowTitle').textContent = track.title || 'No se reproduce';
  $('#nowArtist').textContent = track.channel || '—';
  if(track.thumb) $('#vinylCover').style.backgroundImage = `url('${track.thumb}')`;
  $('#miniThumb').style.backgroundImage = `url('${track.thumb || 'https://dummyimage.com/600x600/222/fff'}')`;
  $('#miniTitle').textContent = track.title || 'No se reproduce';
  $('#miniArtist').textContent = track.channel || '—';
  $('#miniPlayer').classList.remove('hidden');
}

/* =====================
   Rendering results & lists
   ===================== */
function renderResults(list){
  const area = $('#listArea');
  area.innerHTML = '';
  if(!list || list.length===0){ area.innerHTML = `<div style="padding:32px;text-align:center;color:var(--muted)">Sin resultados</div>`; return; }
  list.forEach((tr,i)=>{
    const el = document.createElement('div'); el.className='song';
    const favState = STORAGE.favorites.find(f=>f.videoId===tr.videoId) ? '♥' : '♡';
    el.innerHTML = `
      <div class="thumb" style="background-image:url('${tr.thumb}')"></div>
      <div class="meta"><div class="name">${escapeHtml(tr.title)}</div><div class="sub">${escapeHtml(tr.channel)}</div></div>
      <div class="btns">
        <button class="icon-btn btn-add" title="Añadir a playlist" data-vid="${tr.videoId}"> 
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path></svg>
        </button>
        <button class="icon-btn btn-fav local" title="Favorito">${favState}</button>
        <button class="icon-btn btn-play" title="Reproducir" data-vid="${tr.videoId}">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M5 3v18l15-9L5 3z" fill="currentColor"></path></svg>
        </button>
      </div>`;
    // play when clicking row (but ignore clicks on the small buttons)
    el.addEventListener('click', (ev)=>{
      if(ev.target.closest('.btn-add') || ev.target.closest('.btn-play') || ev.target.closest('.btn-fav')) return;
      queue = list.slice(); currentIndex = i; currentTrack = queue[currentIndex];
      loadAndPlayById(currentTrack.videoId, true, true, currentIndex);
    });
    // individual play button
    el.querySelector('.btn-play').addEventListener('click', (ev)=>{
      ev.stopPropagation();
      queue = list.slice(); currentIndex = i; currentTrack = queue[currentIndex];
      loadAndPlayById(currentTrack.videoId, true, true, currentIndex);
    });
    // add to playlist
    el.querySelector('.btn-add').addEventListener('click', (ev)=>{
      ev.stopPropagation();
      openAddToPlaylistModal(tr);
    });
    // favorite toggle for result rows
    el.querySelector('.btn-fav').addEventListener('click', (ev)=>{
      ev.stopPropagation();
      toggleFavorite(tr);
      const activeTab = document.querySelector('.tab.active')?.dataset?.tab;
      if(activeTab === 'tab-list'){ renderResults(lastResults); }
      else if(activeTab === 'tab-favorites'){ renderFavorites(); }
      else if(activeTab === 'tab-recientes'){ renderRecents(); }
    });
    area.appendChild(el);
  });
}
function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c=>({'&':'&','<':'<','>':'>','"':'"',"'":"'"}[c])); }

/* =====================
   Recents / favorites / playlists
   ===================== */

   
function addRecent(track){
  if(!track || !track.videoId) return;
  STORAGE.recent = STORAGE.recent.filter(t=>t.videoId !== track.videoId);
  STORAGE.recent.push(track);
  if(STORAGE.recent.length > 40) STORAGE.recent = STORAGE.recent.slice(-40);
  saveStorage();
}
function toggleFavorite(track){
  if(!track || !track.videoId) return;
  const ex = STORAGE.favorites.find(t=>t.videoId===track.videoId);
  if(ex) STORAGE.favorites = STORAGE.favorites.filter(t=>t.videoId!==track.videoId);
  else STORAGE.favorites.push(track);
  saveStorage(); showToast(ex ? 'Quitado de favoritos':'Añadido a favoritos');
}
function renderRecents(){
  const area = $('#listArea'); area.innerHTML='';
  if(!STORAGE.recent.length){
    area.innerHTML = `<div style="padding:32px;text-align:center;color:var(--muted)">No hay recientes</div>`;
    return;
  }

  // mostramos en orden invertido para mantener la misma UI (más reciente primero)
  const recList = STORAGE.recent.slice().reverse();

  recList.forEach((tr, idx)=>{
    const el = document.createElement('div'); el.className='song';
    const thumb = (typeof getThumb === 'function') ? getThumb(tr) : (tr.thumb || 'https://dummyimage.com/600x600/ddd/222');
    el.innerHTML = `<div class="thumb" style="background-image:url('${thumb}')"></div>
       <div class="meta"><div class="name">${escapeHtml(tr.title)}</div><div class="sub">${escapeHtml(tr.channel)}</div></div>
       <div class="btns">
         <button class="icon-btn btn-add" title="Añadir a playlist"> 
           <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path></svg>
         </button>
         <button class="icon-btn btn-fav local">${STORAGE.favorites.find(f=>f.videoId===tr.videoId) ? '♥' : '♡'}</button>
         <button class="icon-btn btn-remove" title="Eliminar de recientes">🗑</button>
       </div>`;

    // Click en la fila -> reproducir LA LISTA de Recientes empezando por este índice
    el.addEventListener('click', (ev)=>{
      if(ev.target.closest('.btn-add')||ev.target.closest('.btn-fav')||ev.target.closest('.btn-remove')) return;
      queue = recList.slice();
      currentIndex = idx;
      currentTrack = queue[currentIndex];
      playCurrent();
    });

    // add to playlist
    el.querySelector('.btn-add').addEventListener('click', (ev)=>{ ev.stopPropagation(); openAddToPlaylistModal(tr); });

    // fav toggle
    el.querySelector('.btn-fav').addEventListener('click', (ev)=>{
      ev.stopPropagation();
      toggleFavorite(tr);
      renderRecents(); // re-render para actualizar el icono ♥/♡
    });

    // remove from recents
    el.querySelector('.btn-remove').addEventListener('click', (ev)=>{
      ev.stopPropagation();
      STORAGE.recent = STORAGE.recent.filter(r=>r.videoId !== tr.videoId);
      saveStorage();
      renderRecents();
      showToast('Eliminado de recientes');
    });

    area.appendChild(el);
  });
}

function renderFavorites(){
  const area = $('#listArea'); area.innerHTML='';
  if(!STORAGE.favorites.length){
    area.innerHTML = `<div style="padding:32px;text-align:center;color:var(--muted)">No hay favoritos</div>`;
    return;
  }

  // Mostramos la lista en orden inverso (más reciente primero), igual que antes
  const favList = STORAGE.favorites.slice().reverse();

  favList.forEach((tr, idx)=>{
    const el = document.createElement('div'); el.className='song';
    const thumb = (typeof getThumb === 'function') ? getThumb(tr) : (tr.thumb || 'https://dummyimage.com/600x600/ddd/222');
    el.innerHTML = `<div class="thumb" style="background-image:url('${thumb}')"></div>
       <div class="meta"><div class="name">${escapeHtml(tr.title)}</div><div class="sub">${escapeHtml(tr.channel)}</div></div>
       <div class="btns">
         <button class="icon-btn btn-add" title="Añadir a playlist"> 
           <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path></svg>
         </button>
         <button class="icon-btn btn-fav local">♥</button>
         <button class="icon-btn btn-remove" title="Eliminar de favoritos">🗑</button>
       </div>`;

    // Al hacer click en la fila: reproducir LA LISTA de Favoritos, empezando en este índice
    el.addEventListener('click', (ev)=>{
      if(ev.target.closest('.btn-add')||ev.target.closest('.btn-fav')||ev.target.closest('.btn-remove')) return;
      // establecemos queue como la lista completa de favoritos (en el mismo orden que se muestra)
      queue = favList.slice();
      currentIndex = idx;
      currentTrack = queue[currentIndex];
      playCurrent();
    });

    // botón añadir a playlist
    el.querySelector('.btn-add').addEventListener('click', (ev)=>{ ev.stopPropagation(); openAddToPlaylistModal(tr); });

    // toggle favorito (quita si ya era favorito)
    el.querySelector('.btn-fav').addEventListener('click', (ev)=>{ 
      ev.stopPropagation();
      toggleFavorite(tr); 
      // re-render para reflejar cambio
      renderFavorites();
    });

    // eliminar de favoritos (por videoId para evitar errores de índice)
    el.querySelector('.btn-remove').addEventListener('click', (ev)=>{
      ev.stopPropagation();
      STORAGE.favorites = STORAGE.favorites.filter(r=>r.videoId !== tr.videoId);
      saveStorage();
      renderFavorites();
      showToast('Eliminado de favoritos');
    });

    area.appendChild(el);
  });
}

function renderPlaylistsUI(){
  const area = $('#listArea'); area.innerHTML='';
  const keys = Object.keys(STORAGE.playlists || {});
  if(keys.length===0){ area.innerHTML = `<div style="padding:32px;text-align:center;color:var(--muted)">No hay playlists</div>`; return; }
  keys.forEach(name=>{
    const pl = STORAGE.playlists[name];
    const el = document.createElement('div'); el.className='song';
    el.innerHTML = `<div class="thumb" style="background-image:url('${pl[0]?.thumb || 'https://dummyimage.com/600x600/ddd/222'}')"></div>
      <div class="meta"><div class="name">${escapeHtml(name)}</div><div class="sub">${pl.length} canciones</div></div>
      <div class="btns"><button class="icon-btn btn-open">Abrir</button><button class="icon-btn btn-delete" title="Eliminar playlist">🗑</button></div>`;
    el.querySelector('.btn-open').addEventListener('click', (ev)=>{ ev.stopPropagation(); openPlaylistView(name); });
    el.querySelector('.btn-delete').addEventListener('click', (ev)=>{ ev.stopPropagation(); showModal({title:'Confirmar', html:`<div>Eliminar playlist <b>${escapeHtml(name)}</b>?</div>`, buttons:[{label:'Cancelar'},{label:'Eliminar', onClick: ()=>{ delete STORAGE.playlists[name]; STORAGE.playlists = STORAGE.playlists || {}; saveStorage(); renderPlaylistsUI(); showToast('Eliminada'); }}]}); });
    area.appendChild(el);
  });
}

/* add to playlist */
function openAddToPlaylistModal(track){
  const names = Object.keys(STORAGE.playlists || {});
  const html = `<div style="display:flex;flex-direction:column;gap:8px">
    <div style="font-weight:700">${escapeHtml(track.title)}</div>
    <div class="sub">${escapeHtml(track.channel)}</div>
    <select id="plSelect" style="padding:8px;border-radius:8px;background:#f6f9ff;border:1px solid rgba(16,24,40,0.04)">
      ${names.map(n=>`<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('')}
    </select>
    <input id="newPlName" placeholder="O crear nueva playlist..." style="padding:8px;border-radius:8px;border:1px solid rgba(16,24,40,0.04)"/>
  </div>`;
  showModal({
    title:'Añadir a playlist',
    html,
    buttons:[
      {label:'Cancelar'},
      {label:'Añadir', onClick: ()=>{
        const newName = document.getElementById('newPlName').value.trim();
        const sel = document.getElementById('plSelect')?.value;
        const name = newName || sel;
        if(!name){ showToast('Escribe o selecciona un nombre'); return; }
        if(!STORAGE.playlists[name]) STORAGE.playlists[name] = [];
        STORAGE.playlists[name].push(track); saveStorage(); showToast('Añadido a '+name);
      }}
    ]
  });
}

/* playlist view (modal) */
function openPlaylistView(name){
  const list = STORAGE.playlists[name] || [];
  const html = `<div style="max-height:320px;overflow:auto">
    ${list.map((t, i)=>`
      <div data-i="${i}" class="pl-row" style="display:flex;gap:8px;padding:8px;align-items:center;cursor:pointer">
        <div class="pl-thumb" style="background-image:url('${t.thumb}');background-size:cover"></div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:700">${escapeHtml(t.title)}</div>
          <div class="sub">${escapeHtml(t.channel)}</div>
        </div>
        <div style="display:flex;gap:6px">
          <button class="icon-btn btn-play-pl" data-i="${i}" title="Reproducir">▶</button>
          <button class="icon-btn btn-remove-pl" data-i="${i}" title="Eliminar">🗑</button>
        </div>
      </div>`).join('')}
  </div>`;
  showModal({
    title:'Playlist: '+name,
    html,
    buttons:[
      {label:'Cerrar'},
      {label:'Eliminar', onClick: ()=>{
        showModal({title:'Confirmar', html:`<div>Eliminar playlist <b>${escapeHtml(name)}</b>?</div>`, buttons:[
          {label:'Cancelar'}, {label:'Eliminar', onClick: ()=>{ delete STORAGE.playlists[name]; STORAGE.playlists = STORAGE.playlists || {}; saveStorage(); renderPlaylistsUI(); showToast('Eliminada'); }}
        ]});
      }}
    ]
  });
  // attach click handlers
  setTimeout(()=>{
    document.querySelectorAll('.pl-row').forEach((r)=>{
      r.addEventListener('click', ()=>{
        const i = parseInt(r.dataset.i, 10);
        queue = STORAGE.playlists[name].slice();
        currentIndex = i;
        currentTrack = queue[currentIndex];
        playCurrent();
        closeModal();
      });
    });
    document.querySelectorAll('.btn-play-pl').forEach(b=>{
      b.addEventListener('click', (ev)=>{ ev.stopPropagation(); const i = parseInt(b.dataset.i,10); queue = STORAGE.playlists[name].slice(); currentIndex = i; currentTrack = queue[currentIndex]; playCurrent(); closeModal(); });
    });
    document.querySelectorAll('.btn-remove-pl').forEach(b=>{
      b.addEventListener('click', (ev)=>{ ev.stopPropagation(); const i = parseInt(b.dataset.i,10); STORAGE.playlists[name].splice(i,1); saveStorage(); openPlaylistView(name); showToast('Canción eliminada'); });
    });
  }, 60);
}

/* create playlist */
$('#btnCreatePL').addEventListener('click', ()=>{
  showModal({
    title:'Crear playlist',
    html:`<input id="plNameInput" placeholder="Nombre playlist" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(16,24,40,0.04)"/>`,
    buttons:[
      {label:'Cancelar'},
      {label:'Crear', onClick: ()=>{ const nm = $('#plNameInput').value.trim(); if(!nm){ showToast('Nombre requerido'); return; } if(STORAGE.playlists[nm]){ showToast('Ya existe'); return; } STORAGE.playlists[nm]=[]; saveStorage(); renderPlaylistsUI(); showToast('Creada'); }}
    ]
  });
});


/* ==========================
   Mini-player: mandar al fondo / traer al frente
   ========================== */
function miniToBack(){
  const m = document.getElementById('miniPlayer');
  if(m) m.classList.add('behind');
}
function miniToFront(){
  const m = document.getElementById('miniPlayer');
  if(m) m.classList.remove('behind');
}

/* activar el mini al fondo mientras el usuario escribe en el buscador */
$('#searchBtn').addEventListener('click', onSearch);


/* ==========================
   Autocomplete + debounce
   ========================== */

function debounce(fn, wait){
  let t = null;
  return function(...args){
    clearTimeout(t);
    t = setTimeout(()=> fn.apply(this, args), wait);
  };
}

const suggestionsContainer = document.getElementById('suggestions');
let suggestionList = [];
let suggestionIndex = -1; // índice resaltado

// render suggestions into the dropdown
function renderSuggestions(list){
  if(!suggestionsContainer) return;
  suggestionsContainer.innerHTML = '';
  if(!list || list.length === 0){
    suggestionsContainer.style.display = 'none';
    suggestionList = [];
    suggestionIndex = -1;
    return;
  }
  list.forEach((it, i)=>{
    const div = document.createElement('div');
    div.className = 'suggestion-item';
    div.setAttribute('role','option');
    div.dataset.i = i;
    div.innerHTML = `
      <div class="suggestion-thumb" style="background-image:url('${it.thumb || 'https://dummyimage.com/600x600/ddd/222'}')"></div>
      <div class="suggestion-body">
        <div class="suggestion-title">${escapeHtml(it.title)}</div>
        <div class="suggestion-sub">${escapeHtml(it.channel)}</div>
      </div>
    `;
    // mousedown en vez de click para evitar que el blur del input limpie antes
    div.addEventListener('mousedown', (ev)=>{
      ev.preventDefault();
      selectSuggestionByIndex(i);
    });
    div.addEventListener('mouseover', ()=> setSuggestionIndex(i));
    suggestionsContainer.appendChild(div);
  });
  suggestionList = list.slice();
  suggestionIndex = -1;
  highlightSuggestion();
  suggestionsContainer.style.display = 'block';
}

function clearSuggestions(){
  if(!suggestionsContainer) return;
  suggestionsContainer.innerHTML = '';
  suggestionsContainer.style.display = 'none';
  suggestionList = [];
  suggestionIndex = -1;
}

function setSuggestionIndex(i){
  suggestionIndex = i;
  highlightSuggestion();
}

function moveSuggestion(delta){
  if(!suggestionList.length) return;
  suggestionIndex = ( (suggestionIndex + delta) + suggestionList.length ) % suggestionList.length;
  highlightSuggestion();
  // scroll into view for the highlighted element
  const el = suggestionsContainer.children[suggestionIndex];
  if(el) el.scrollIntoView({block:'nearest'});
}

function highlightSuggestion(){
  const items = suggestionsContainer.children;
  for(let j=0;j<items.length;j++){
    items[j].classList.toggle('active', j === suggestionIndex);
  }
}

function selectSuggestionByIndex(i){
  const item = suggestionList[i];
  if(!item) return;
  // comportamiento: rellenar input con el título seleccionado y ejecutar búsqueda (no autoplay)
  $('#searchInput').value = item.title || '';
  clearSuggestions();
  onSearch(); // muestra resultados para el título seleccionado
}

/* debounce wrapper that queries youtube for suggestions */
const doSuggest = debounce(async (q)=>{
  if(!q) { clearSuggestions(); return; }
  try{
    const res = await youtubeSearch(q, Math.min(5, CONFIG.YT_MAX_RESULTS));
    renderSuggestions(res || []);
  }catch(err){
    console.warn('suggest error', err);
    clearSuggestions();
  }
}, 300);

/* --- attach enhanced listeners to search input --- */
const searchInputEl = document.getElementById('searchInput');
if(searchInputEl){
  // input -> suggestions (debounced), y UI overlay / mini control (ya tenías esto)
  searchInputEl.addEventListener('input', (e)=>{
    const v = e.target.value || '';
    if(v.trim()){
      document.getElementById('rightPanel').classList.add('search-active');
      miniToBack();
    } else {
      document.getElementById('rightPanel').classList.remove('search-active');
      miniToFront();
      clearSuggestions();
    }
    doSuggest(v.trim());
  });

  // key navigation
  searchInputEl.addEventListener('keydown', (e)=>{
    // if suggestions visible, handle up/down/enter/esc
    const visible = suggestionList && suggestionList.length > 0;
    if(visible){
      if(e.key === 'ArrowDown'){ e.preventDefault(); moveSuggestion(1); return; }
      if(e.key === 'ArrowUp'){ e.preventDefault(); moveSuggestion(-1); return; }
      if(e.key === 'Enter'){ e.preventDefault(); if(suggestionIndex >= 0) selectSuggestionByIndex(suggestionIndex); else onSearch(); return; }
      if(e.key === 'Escape'){ clearSuggestions(); return; }
    } else {
      // sin sugerencias: Enter hace búsqueda normal
      if(e.key === 'Enter'){ e.preventDefault(); onSearch(); return; }
    }
  });

  // blur: esperar un momento para permitir clicks en sugerencias (mousedown handled above)
  searchInputEl.addEventListener('blur', ()=>{
    setTimeout(()=>{
      document.getElementById('rightPanel').classList.remove('search-active');
      miniToFront();
      clearSuggestions();
    }, 180);
  });
}

// keep the search button binding (should already exist)
if(!$('#searchBtn').onclick) $('#searchBtn').addEventListener('click', onSearch);



/* =====================
   Events & behaviors
   ===================== */
$('#searchBtn').addEventListener('click', onSearch);
$('#searchInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') onSearch(); });
$('#playBtn').addEventListener('click', togglePlayPause);
$('#miniPlay').addEventListener('click', togglePlayPause);
$('#prevBtn').addEventListener('click', playPrev);
$('#nextBtn').addEventListener('click', playNext);
$('#miniPrev').addEventListener('click', playPrev);
$('#miniNext').addEventListener('click', playNext);

/* ===== UI updates for repeat/shuffle (replace old handlers that used inline opacity) ===== */

function updateShuffleButtonUI(){
  const btn = $('#shuffleBtn');
  if(!btn) return;
  // quitar clases previas
  btn.classList.remove('toggle','active','inactive','shuffle-active');
  btn.classList.add('toggle');
  if(shuffle){
    // si quieres verde para shuffle, usar 'active' en vez de 'shuffle-active'
    btn.classList.add('shuffle-active'); // o 'active' para verde
    btn.classList.remove('inactive');
    btn.setAttribute('aria-pressed', 'true');
  } else {
    btn.classList.remove('shuffle-active');
    btn.classList.add('inactive');
    btn.setAttribute('aria-pressed', 'false');
  }
  btn.title = 'Aleatorio: ' + (shuffle ? 'ON' : 'OFF');
}

function updateRepeatButtonUI(){
  const btn = $('#repeatBtn');
  if(!btn) return;
  btn.classList.remove('toggle','repeat-none','repeat-all','repeat-one','inactive');
  btn.classList.add('toggle');

  if(repeatMode === 'none'){
    btn.classList.add('repeat-none');
    btn.classList.add('inactive');
    btn.setAttribute('aria-pressed', 'false');
  } else if(repeatMode === 'all'){
    btn.classList.add('repeat-all'); // usará el estilo activo (verde)
    btn.setAttribute('aria-pressed', 'true');
  } else if(repeatMode === 'one'){
    btn.classList.add('repeat-one'); // estilo activo + badge '1'
    btn.setAttribute('aria-pressed', 'true');
  }
  btn.title = 'Repetir: ' + repeatMode;
}

/* Reemplazamos los handlers por llamadas a las funciones que actualizan UI */
$('#shuffleBtn').addEventListener('click', ()=>{ 
  shuffle = !shuffle; 
  updateShuffleButtonUI(); 
  showToast('Aleatorio: '+(shuffle?'ON':'OFF')); 
});

$('#repeatBtn').addEventListener('click', ()=>{
  repeatMode = repeatMode === 'none' ? 'all' : (repeatMode === 'all' ? 'one' : 'none');
  updateRepeatButtonUI();
  showToast('Repetir: '+repeatMode);
});

/* minimize */
function minimize(){ $('#leftCard').classList.add('hidden'); $('#miniPlayer').classList.remove('hidden'); showToast('Minimizado — reproducción continúa'); }

$('#btnMinimize').addEventListener('click', minimize);
$('#miniPlayer').addEventListener('click', ()=>{ $('#leftCard').classList.remove('hidden'); $('#miniPlayer').classList.add('hidden'); });

/* queue modal - build with clickable rows that close on click */
$('#btnQueue').addEventListener('click', ()=>{
  if(!queue || !queue.length) return showToast('Cola vacía');
  const html = `<div style="max-height:380px;overflow:auto">${queue.map((t,i)=>`<div data-i="${i}" class="queue-row" style="display:flex;gap:8px;padding:8px;align-items:center;cursor:pointer"><div style="width:44px;height:44px;background-image:url('${t.thumb}');background-size:cover;border-radius:8px"></div><div style="flex:1"><div style="font-weight:700">${escapeHtml(t.title)}</div><div class="sub">${escapeHtml(t.channel)}</div></div><div style="width:48px;text-align:center">${i===currentIndex?'<small>▶</small>':''}</div></div>`).join('')}</div>`;
  showModal({title:'Cola', html, buttons:[{label:'Cerrar'}]});
  setTimeout(()=>{
    document.querySelectorAll('.queue-row').forEach(r=>{
      r.addEventListener('click', ()=>{
        const i = parseInt(r.dataset.i, 10);
        currentIndex = i;
        playCurrent();
        closeModal();
      });
    });
  }, 60);
});

/* video toggle */
$('#btnVideoToggle').addEventListener('click', ()=>{
  videoShown = !videoShown;
  $('#videoBox').style.display = videoShown ? 'block' : 'none';
  if(currentTrack){
    try{
      const cur = (visiblePlayer && visiblePlayer.getCurrentTime) ? visiblePlayer.getCurrentTime() : 0;
      if(!videoShown && hiddenPlayer && hiddenPlayer.loadVideoById){ hiddenPlayer.loadVideoById({videoId: currentTrack.videoId, startSeconds: cur}); hiddenPlayer.playVideo(); visiblePlayer && visiblePlayer.stopVideo && visiblePlayer.stopVideo(); }
      if(videoShown && visiblePlayer && visiblePlayer.loadVideoById){ visiblePlayer.loadVideoById({videoId: currentTrack.videoId, startSeconds: cur}); visiblePlayer.playVideo(); hiddenPlayer && hiddenPlayer.stopVideo && hiddenPlayer.stopVideo(); }
    }catch(e){}
  }
});

/* fullscreen: try iframe, fallback to open youtube */
$('#btnFullScreen').addEventListener('click', ()=>{
  try{
    let iframe = null;
    if(visiblePlayer && typeof visiblePlayer.getIframe === 'function') iframe = visiblePlayer.getIframe();
    if(iframe){
      if(iframe.requestFullscreen) iframe.requestFullscreen();
      else if(iframe.webkitRequestFullscreen) iframe.webkitRequestFullscreen();
      else window.open('https://www.youtube.com/watch?v=' + (currentTrack?.videoId || ''), '_blank');
    }else{
      if(currentTrack && currentTrack.videoId) window.open('https://www.youtube.com/watch?v=' + currentTrack.videoId, '_blank');
    }
  }catch(e){
    if(currentTrack && currentTrack.videoId) window.open('https://www.youtube.com/watch?v=' + currentTrack.videoId, '_blank');
  }
});

/* search: now DOES NOT autoplay first result; sólo muestra resultados y deja la reproducción existente */
// search: muestra resultados, y al finalizar trae el mini al frente
// search: muestra resultados (NO hace autoplay del primer resultado) y limpia sugerencias
let lastResults = [];
async function onSearch(){
  const q = $('#searchInput').value.trim();
  if(!q){ showToast('Escribe para buscar'); return; }

  try{
    const res = await youtubeSearch(q, CONFIG.YT_MAX_RESULTS);
    lastResults = res || [];
    if(res && res.length > 0){
      renderResults(res);
    } else {
      $('#listArea').innerHTML = `<div style="padding:32px;text-align:center;color:var(--muted)">No se encontraron resultados</div>`;
    }
  }catch(e){
    console.warn('search error', e);
    $('#listArea').innerHTML = `<div style="padding:32px;text-align:center;color:var(--muted)">Error buscando</div>`;
  } finally {
    // mantener el texto en el input (no limpiarlo) y normalizar UI: quitar overlay y traer mini adelante
    document.getElementById('rightPanel').classList.remove('search-active');
    miniToFront();
    clearSuggestions();
  }
}



/* tabs */
$$('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const id = t.dataset.tab;
    if(id === 'tab-list'){ renderResults(lastResults.length ? lastResults : []); }
    else if(id === 'tab-recientes'){ renderRecents(); }
    else if(id === 'tab-favorites'){ renderFavorites(); }
    else if(id === 'tab-playlists'){ renderPlaylistsUI(); }
  });
});

/* initial renders */
function renderAll(){ renderRecents(); renderPlaylistsUI(); }
renderAll();
// Añade esto justo después para sincronizar botones con el estado actual:
updateShuffleButtonUI();
updateRepeatButtonUI();

/* small click outside to remove blur state */
document.addEventListener('click', (e)=>{ if(!e.target.closest('.search-box')) $('#rightPanel').classList.remove('search-active'); });

/* initial toast */
showToast('Listo — busca y toca una fila para reproducir');

/* expose for debugging si quieres */
window._mp = {STORAGE, saveStorage, queue};

/* =====================
   Visibility handling: transfer to hidden player when page hidden
   ===================== */
document.addEventListener('visibilitychange', async ()=>{
  try{
    if(document.hidden){
      if(visiblePlayer && visiblePlayer.getPlayerState && visiblePlayer.getPlayerState() === YT.PlayerState.PLAYING){
        const cur = visiblePlayer.getCurrentTime ? visiblePlayer.getCurrentTime() : 0;
        const vid = currentTrack?.videoId;
        if(vid && hiddenPlayer && hiddenPlayer.loadVideoById){
          hiddenPlayer.loadVideoById({videoId:vid, startSeconds: cur});
          hiddenPlayer.playVideo && hiddenPlayer.playVideo();
          visiblePlayer.stopVideo && visiblePlayer.stopVideo();
        }
      }
    } else {
      if(hiddenPlayer && hiddenPlayer.getPlayerState && hiddenPlayer.getPlayerState() === YT.PlayerState.PLAYING){
        const cur = hiddenPlayer.getCurrentTime ? hiddenPlayer.getCurrentTime() : 0;
        const vid = currentTrack?.videoId;
        if(vid && visiblePlayer && visiblePlayer.loadVideoById){
          visiblePlayer.loadVideoById({videoId:vid, startSeconds: cur});
          visiblePlayer.playVideo && visiblePlayer.playVideo();
          hiddenPlayer.stopVideo && hiddenPlayer.stopVideo();
        }
      }
    }
  }catch(e){ console.warn('visibility transfer error', e); }
});

/* small helper to show mini */
function showMini(show=true){ if(show) $('#miniPlayer').classList.remove('hidden'); else $('#miniPlayer').classList.add('hidden'); }

</script>
</body>
</html>
